<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name='viewport' content='width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no'/>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <title>Тюнинг</title>
    <link rel="shortcut icon" href="favicon.png" type="image/png">
    <link rel="stylesheet" type="text/css" href="global.css">
    <style>

    </style>
    <script>
        var requestWeight = null;
        var weight;
        var scale;
        var offset;
        var adc;
        function getOffset() {
            var request = new XMLHttpRequest();
            request.onreadystatechange = function(){
                if (this.readyState === 4 && this.status === 200){
                    offset = parseInt(this.responseText);
                    document.getElementById("off_id").innerHTML = offset;
                }
            };
            request.open('GET','/av',true);
            request.send(null);

        }
        function getAdc() {
            var request = new XMLHttpRequest();
            request.onreadystatechange = function(){
                if (this.readyState === 4 && this.status === 200){
                    adc = this.responseText;
                }
            };
            request.open('GET','/av',true);
            request.send(null);

        }
        function calculate(){
            var dif = weight - parseFloat(document.getElementById('id_cal_wt').value);
            dif = parseFloat(document.getElementById('gr_id').value) / dif;
            dif =  parseFloat(document.getElementById('id_cal_wt').value) * dif;
            document.getElementById('id_cal_wt').value = dif.toFixed(document.getElementById('ac_id').value);
            setWeight();
        }
        function handleWeight() {
            if (this.readyState === 4 && this.status === 200){
                if (this.responseText !== null){
                    weight = (parseInt(this.responseText)-offset);
                    weight = parseFloat(weight) * scale;
                    document.getElementById("wt_id").innerHTML = weight.toFixed(parseInt(document.getElementById('ac_id').value));
                    var dif_gr = parseFloat(document.getElementById('id_cal_wt').value) + parseFloat(document.getElementById('gr_id').value);
                    dif_gr -= weight;
                    document.getElementById('dif_gr_id').innerHTML = dif_gr.toFixed(document.getElementById('ac_id').value);
                    getWeight();
                }
            }
        }
        function setWeight() {
            var request = new XMLHttpRequest();
            request.onreadystatechange = function(){
                if (this.readyState === 4 && this.status === 200){
                    var w = parseFloat(document.getElementById('id_cal_wt').value) + parseFloat(document.getElementById('gr_id').value);
                    scale = w /(parseInt(this.responseText) - offset);
                }
            };
            request.open('GET','/av',true);
            request.send(null);
        }
        function go() {
            document.getElementById('wt_id').innerHTML = '---';
            getWeight();
        }
        function getWeight(){
            if((navigator.userAgent.indexOf("MSIE") !== -1 ) || (!!document.documentMode === true )){
                requestWeight.open('GET','/av?buster='+new Date().getTime(),true);
            }else{
                requestWeight.open('GET','/av',true);
            }
            requestWeight.send(null);
        }
        window.onload = function () {
            try{
                requestWeight = new XMLHttpRequest();
            }catch (e){
                try{
                    requestWeight = new ActiveXObject("Msxml2.XMLHTTP");
                }catch (e) {
                    try{
                        requestWeight = new ActiveXObject("Microsoft.XMLHTTP");
                    }catch (e){
                        alert("Your browser broke!");
                        return false;
                    }
                }
            }
            requestWeight.onreadystatechange = handleWeight;
            requestWeight.timeout = 5000;
            requestWeight.ontimeout = function(){go();};
            requestWeight.onerror = function(){go();};
            getWeight();
        };
    </script>
</head>
<body>
<a href="/" class="btn btn--s btn--blue">&lt;</a>&nbsp;&nbsp;<strong>Калибровка</strong>
<hr>
<fieldset>
    <legend>Нулевой вес</legend>
    <form  action='javascript:getOffset()'>
        <div id="off_id"></div>
        <p>Перед установкой убедитесь что весы не нагружены.</p>
        <input type='submit' value='УСТАНОВИТЬ НОЛЬ'/>
    </form>
</fieldset>
<fieldset>
    <legend>Калиброваный вес</legend>
    <form action='javascript:setWeight()'>
        <table>
        </table>
        <div id="av_id">---</div>
        <table>
            <tr>
                <td>Вес</td>
                <td>
                    <select id="ac_id" name='weightAccuracy' title="Выбор точности с которым будет измерения">
                        <option name="0" value="0"> 0 </option>
                        <option name="0.0" value="1"> 0.0 </option>
                        <option name="0.00" value="2"> 0.00 </option>
                        <option name="0.000" value="3"> 0.000 </option>
                    </select>
                </td>
                <td><div id="wt_id">---</div></td>
            </tr>
            <tr>
                <td>ГИРЯ:</td><td><input id="gr_id" value='0' placeholder='Калиброваная гиря'/></td><td><div id="dif_gr_id"></div></td>
            </tr>
            <tr>
                <td>ГРУЗ:</td><td><input title='Введите значение веса установленого на весах' type='number' step='any' max='100000' id='id_cal_wt' required placeholder='Вес груза'/></td>
                <td><a href="javascript:calculate();">подобрать</a></td>
            </tr>
        </table>
        <input type='submit' value='УСТАНОВИТЬ'/>
    </form>
</fieldset>
</body>
</html>